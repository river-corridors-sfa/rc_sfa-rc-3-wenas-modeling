---
title: "02_Wenas_practice_generating_output_df"
output: html_document
date: "2023-05-02"
editor_options: 
  chunk_output_type: console
---
The purpose of this script is generate an output dataframe that is similar to Table 1 in Dove & Hart, 2017 (https://link.springer.com/article/10.4996/fireecology.130237746) that includes: 
Study_ID
Years since fire (TSF)
Climate 
control replicates (Nc)
control mean (Xc)
experimental replicates (Ne)
experimental mean (Xe) 
the natural log of the response ratio (ln[R])
Percent change (percent_change)
Percent change standard deviation (percent_changeSD)
effect size standard deviation (EsSD)
Difference (Diff)
AND 
Difference standard deviation (DiffSD) 
FOR EACH STUDY_ID

We also want to create a figure showing the variability of percent change between sites that have been burned compared to their reference site that is listed in the study_ID

Workflow:
Step 1) Load in meta data sheet from googledrive located in "Fire numerical modeling Paper->Background Figure_MEBandVGC->Wenas_modeling_Papers_use_for_Fig"

Step 2) Clean spreadsheet to filter only data that is needed 

Step 3) Group by study_ID and obtain values listed above

Step 4) Save output file as: in "enter_directory filepath"




## Load packages and set working directory
```{r Jake/Mac}
#for Jake/mac

rm(list=ls(all=T)) #this clears your Environment

library(ggplot2)
library(googlesheets4)
library(tidyverse)
library(lubridate)
```


```{r Metadata Google Sheet Import}
#import Metadata sheet that is stored on Google Sheet 
metadata <- read_sheet("https://docs.google.com/spreadsheets/d/1S1-Aheu-BJiIybye95YQzRi_9e2kS-udcsKcsC7H8dk/edit#gid=0",col_types ='c')

#you may need OAuth access. Press 1 to grant access

# select the columns that I want 
metadata <- metadata %>% select("Study_ID", "Pair_JSC", "Climate_JSC_from_climatecharts.com", 
                       "Burn or Unburn", "Time_Since_Fire", "Time_Since_Fire_JSC",
                 "DOC_mg_C_L", "STDEV_DOC", "STER_DOC",
                 "TN_mg_N_per_L", "STDEV_TN", "STER_TN",
                 "TDN_mg_N_per_L", "STDEV_TDN", "STER_TDN",
                 "NO3_mg_per_L_as_Nitrate", "STDEV_NO3", "STER_NO3",
                 "NH4_mg_per_L_as_NH4", "STER_NH4")

# rename some of the columns 
metadata <- metadata %>% 
    rename("Treatment" = "Burn or Unburn",
           "Climate" = "Climate_JSC_from_climatecharts.com") 


# substituting all greater than or less than characters out 
# metadata <- metadata %>% 
#   mutate_all(str_remove(.,"<"))

metadata <- as.data.frame(sapply(metadata, gsub, pattern = "<|>", replacement = ""))

# making all concentraions numeric
metadata <- metadata %>% mutate_at(c("DOC_mg_C_L", "STDEV_DOC", "STER_DOC",
                               "TN_mg_N_per_L", "STDEV_TN", "STER_TN",
                               "TDN_mg_N_per_L", "STDEV_TDN", "STER_TDN",
                               "NO3_mg_per_L_as_Nitrate", "STDEV_NO3", "STER_NO3",
                               "NH4_mg_per_L_as_NH4", "STER_NH4"), as.numeric)

# Filter only post-burn/reference # study_ID 22 has some pre-burn and post-burn means that I want to ignore right now 
metadata <- metadata %>% 
  filter(Treatment == "Burn" | Treatment == "Unburn")

# Create a column that takes the time_since_fire column and mutates it into categorical buckets 
unique(metadata$Time_Since_Fire)

# BRIE advice for the below chunk #
# remove years using string remove 
# something within tidy to work with factors 
# look at the factors link in the chat 

# JSC solution to this mutate 
metadata <- metadata %>% 
  mutate(metadata, TSF = ifelse(grepl("12-13", Time_Since_Fire), ">10 years",
                              ifelse(grepl("0|0-1|0-2|1 month|1|2|3|1-3|1-2", Time_Since_Fire), "0-3 years",
                              ifelse(grepl("4|5", Time_Since_Fire), "4-5 years",
                              ifelse(grepl("6|7|8|9|10", Time_Since_Fire), "6-10 years",
                              ifelse(grepl("Pre-fire", Time_Since_Fire), "Pre-Fire",
                              ifelse(grepl("1-13 years post fire|Post-fire", Time_Since_Fire), "Post-Fire", "Other")))))))

# None should be classified as Other #



```


```{r Analyte summary stats}

# pivoting to make the responses in one column
metadata_long <- metadata %>% 
  pivot_longer(
    cols = DOC_mg_C_L:STER_NH4,
    names_to = "response_var",
    values_to = "mean_concentration",
    values_drop_na = TRUE
  )

# calculating the mean of all the burns and all the controls by analyte for each study #
MeanConcTest <- metadata_long %>%
  group_by(Study_ID, Pair_JSC, Treatment, response_var, Climate, TSF) %>%
  dplyr::summarize(Ne = sum(Treatment == "Burn"),
                   Nc = sum(Treatment == "Unburn"),
                   Xe = mean(mean_concentration[Treatment == "Burn"], na.rm = TRUE),
                   Xc = mean(mean_concentration[Treatment == "Unburn"], na.rm = TRUE))




# This is calculating the mean for EACH site within a study_ID # 
    # Any study_ID that doesn't have up to 10 sites will have a 0 in the respective Xen column 
analyte_table_means <- MeanConcTest %>%
  select(-Pair_JSC) %>%
  group_by(Study_ID, response_var, Climate, TSF) %>%
  summarize(Ne = sum(Ne),
            Nc = sum(Nc),
            Xe1 = sum(Xe[Pair_JSC == "Site 1"], na.rm = TRUE),
            Xe2 = sum(Xe[Pair_JSC == "Site 2"], na.rm = TRUE),
            Xe3 = sum(Xe[Pair_JSC == "Site 3"], na.rm = TRUE),
            Xe4 = sum(Xe[Pair_JSC == "Site 4"], na.rm = TRUE),
            Xe5 = sum(Xe[Pair_JSC == "Site 5"], na.rm = TRUE),
            Xe6 = sum(Xe[Pair_JSC == "Site 6"], na.rm = TRUE),
            Xe7 = sum(Xe[Pair_JSC == "Site 7"], na.rm = TRUE),
            Xe8 = sum(Xe[Pair_JSC == "Site 8"], na.rm = TRUE),
            Xe9 = sum(Xe[Pair_JSC == "Site 9"], na.rm = TRUE),
            Xe10 = sum(Xe[Pair_JSC == "Site 10"], na.rm = TRUE),
            Xc = sum(Xc[Pair_JSC == "Control"], na.rm = TRUE)) 

# making all the cells with 0 due to no sites beyond what the study had NAs to visualize the dataframe a little better. 
analyte_table_means[analyte_table_means == 0] <- NA

# This chunk is calculating the percent_change between the sites and the control. 
# study_ID 12 is the ONLY site with multiple controls. SO I am filtering it out for now:
### BRIE advice ###
# study_ID 12 is the poo poo study with multiple controls
# pulling it out and then put it back in using add_row
# ifelse statement teaching moment- wee

analyte_table_percent_change <- analyte_table_means %>% 
  filter(Study_ID != "12") %>% 
  group_by(Study_ID, response_var, Climate, TSF) %>%
  mutate(percent_change1 = (((Xe1-Xc)/Xc)*100),
         percent_change2 = (((Xe2-Xc)/Xc)*100),
         percent_change3 = (((Xe3-Xc)/Xc)*100),
         percent_change4 = (((Xe4-Xc)/Xc)*100),
         percent_change5 = (((Xe5-Xc)/Xc)*100),
         percent_change6 = (((Xe6-Xc)/Xc)*100),
         percent_change7 = (((Xe7-Xc)/Xc)*100),
         percent_change8 = (((Xe8-Xc)/Xc)*100),
         percent_change9 = (((Xe9-Xc)/Xc)*100),
         percent_change10 = (((Xe10-Xc)/Xc)*100))

# This is doing the same thing as analyte_table_means chunk but adding in the multiple controls for study_ID_12

brie_test <- MeanConcTest %>% 
  filter(Study_ID == "12") %>% 
  group_by(Study_ID, response_var, Climate, TSF) %>%
  summarize(Xe1 = sum(Xe[Pair_JSC == "Site 1"], na.rm = TRUE),
            Xe2 = sum(Xe[Pair_JSC == "Site 2"], na.rm = TRUE),
            Xe3 = sum(Xe[Pair_JSC == "Site 3"], na.rm = TRUE),
            Xe4 = sum(Xe[Pair_JSC == "Site 4"], na.rm = TRUE),
            Xe5 = sum(Xe[Pair_JSC == "Site 5"], na.rm = TRUE),
            Xc123 = sum(Xc[Pair_JSC == "Control 1, 2, and 3"], na.rm = TRUE),
            Xc4 = sum(Xc[Pair_JSC == "Control 4"], na.rm = TRUE),
            Xc5 = sum(Xc[Pair_JSC == "Control 5"], na.rm = TRUE)) 

# This is doing the same as analyte_table_percent_change but for study_ID_12
# I am also adding columns to match the columns to ultimately combine analyte_table_percent_change with this below chunk that does the stats for study_ID_12
brie_test_stats <- brie_test %>% 
  group_by(Study_ID, response_var, Climate, TSF) %>%
  mutate(percent_change1 = (((Xe1-Xc123)/Xc123)*100),
         percent_change2 = (((Xe2-Xc123)/Xc123)*100),
         percent_change3 = (((Xe3-Xc123)/Xc123)*100),
         percent_change4 = (((Xe4-Xc4)/Xc4)*100),
         percent_change5 = (((Xe5-Xc5)/Xc5)*100)) %>% 
  add_column(Ne = NA,
             Nc = NA,
             Xe6 = NA,
             Xe7 = NA,
             Xe8 = NA,
             Xe9 = NA,
             Xe10 = NA,
             Xc = NA,
             percent_change6 = NA,
             percent_change7 = NA,
             percent_change8 = NA,
             percent_change9 = NA,
             percent_change10 = NA) %>% 
  ungroup()

# Adding columns to match brie_test_stats
analyte_table_percent_change <-analyte_table_percent_change %>% 
  add_column(Xc123 = NA,
             Xc4 = NA,
             Xc5 = NA) %>% 
  ungroup()

# combining study_ID_12 back into the mix 
analyte_table_combine <- analyte_table_percent_change %>% 
  add_row(brie_test_stats)


# pivoting to make the responses in one column
analyte_table_long <- analyte_table_combine %>% 
  pivot_longer(
    cols = percent_change1:percent_change10,
    names_to = "Site",
    values_to = "Percent_Difference",
    values_drop_na = TRUE
  )


#### Ploting ####
vn = expression(paste(""*N*O[3]^"-"))

# filter out the only analytes that we want to include in the figure 
analyte_table_filter <- analyte_table_long %>% 
  filter(response_var == "DOC_mg_C_L"| response_var == "NO3_mg_per_L_as_Nitrate")

# boxplot with all the sites in one box 
ggplot(analyte_table_filter, aes(x = Percent_Difference, y = response_var, fill = response_var)) +
  geom_boxplot() +
  geom_vline(xintercept = 0, linewidth = 1.0, color = "red") +
  xlab("Percent Difference") +
  ylab("") +
  theme(axis.text.y = element_blank()) +
  scale_fill_brewer(palette="Set1") +
  facet_wrap(~Study_ID, scales = "free") +
  theme_classic()

ggsave("all.sites.difference.box.pdf",
       path = ("~/GitHub/rc_sfa-rc-3-wenas-modeling/Lit_Review_Fig"),
       width = 25, height = 20, units = "in")

# boxplot with sites broken up #
ggplot(analyte_table_filter, aes(x = Percent_Difference, y = response_var, fill = response_var)) +
  geom_vline(xintercept = 0, linewidth = 1.0, color = "red") +
  geom_boxplot() +
  xlab("Difference") +
  ylab("") +
  xlim(-2.5, 2.5) +
  theme(axis.text.y = element_blank()) +
  scale_fill_brewer(palette="Set1") +
  facet_wrap(~Study_ID, scales = "free") +
  theme_classic()

ggsave("test.site.difference.box.pdf",
       path = ("~/GitHub/rc_sfa-rc-3-wenas-modeling/Lit_Review_Fig"),
       width = 25, height = 20, units = "in")


# boxplot grouped by Climate #
ggplot(analyte_table_filter, aes(x = Percent_Difference, y = Climate, fill = response_var)) +
  geom_boxplot() +
  geom_jitter(shape=16, position=position_jitter(0.2)) +
  geom_vline(xintercept = 0, linewidth = 1.0, color = "red") +
  xlab("Percent Difference") +
  ylab("") +
  xlim(-100, 700) + 
  scale_fill_brewer(palette="Set1",
                    guide = guide_legend(title = "Analyte"),
                     labels = c('DOC', vn)) +
  theme_classic() +
  theme(axis.text.y = element_text(size = 20),
        axis.text.x = element_text(size = 20),
        axis.title.x = element_text(size = 25))

ggsave("Climate.sites.difference.box.pdf",
       path = ("~/GitHub/rc_sfa-rc-3-wenas-modeling/Lit_Review_Fig"),
       width = 10, height = 8, units = "in")

# boxplot grouped by TSF #
ggplot(analyte_table_filter, aes(x = Percent_Difference, y=TSF, fill = response_var)) +
  geom_boxplot() +
  geom_vline(xintercept = 0, linewidth = 1.0, color = "red") +
  xlab("Percent Difference") +
  ylab("") +
  xlim(-100, 700) + 
  scale_fill_brewer(palette="Set1",
                    guide = guide_legend(title = "Analyte"),
                     labels = c('DOC', vn)) +
  theme_classic() +
  theme(axis.text.y = element_text(size = 20),
        axis.text.x = element_text(size = 20),
        axis.title.x = element_text(size = 25))

ggsave("TSF.sites.difference.box.pdf",
       path = ("~/GitHub/rc_sfa-rc-3-wenas-modeling/Lit_Review_Fig"),
       width = 10, height = 8, units = "in")


# I want to pivot_longer to make all means in one column
# pivoting to make the responses in one column
analyte_table_long_2 <- analyte_table_filter %>% 
  pivot_longer(
    cols = Xe1:Xc5,
    names_to = "Stats",
    values_to = "Value",
    values_drop_na = TRUE
  )


# duplicating code 
my_data[!duplicated(my_data$Sepal.Width), ]
# Calculating the standard deviation for all of the means 
# calculating the mean percent_difference by climate 
climate.summary <- analyte_table_long_2 %>%
  group_by(Climate, response_var) %>%
  summarise(
    sd = sd(Value*100, na.rm = TRUE),
    Percent_Difference = mean(Percent_Difference)
  )

climate.summary.test <- analyte_table_filter %>%
  group_by(Climate, response_var) %>%
  summarise(
    sd = sd(Percent_Difference, na.rm = TRUE),
    Percent_Difference = mean(Percent_Difference)
  )


# geom_jitter for climate # 
ggplot(analyte_table_filter, aes(Percent_Difference, Climate, color = response_var),
       position = position_dodge(width = -0.5)) +
  geom_jitter(position = position_jitter(0.1), alpha = 0.4) +
  geom_pointrange(aes(xmin = Percent_Difference - sd, xmax = Percent_Difference + sd, 
                      color = response_var),
                      position = position_dodge(width = -0.5), data = climate.summary.test) +
  geom_vline(xintercept = 0, linewidth = 0.5, color = "red") +
  xlim(-100, 700) +
  scale_color_manual(values = c("#00AFBB", "#E7B800"),
                     guide = guide_legend(title = "Analyte"),
                     labels = c('DOC', vn)) +
  theme_classic()

ggsave("site.difference.geom_pointrange.climate.pdf",
       path = ("~/GitHub/rc_sfa-rc-3-wenas-modeling/Lit_Review_Fig"),
       width = 10, height = 8, units = "in")

# Calculating the standard deviation for all of the means 
# calculating the mean percent_difference by TSF
TSF.summary <- analyte_table_long_2 %>%
  group_by(TSF, response_var) %>%
  summarise(
    sd = sd(Value*100, na.rm = TRUE),
    Percent_Difference = mean(Percent_Difference)
  )


# geom_jitter for TSF # 
# Creating an order in which I want to plot the y-axis
level_order <- c('0-3 years', '4-5 years', '>10 years') 

ggplot(analyte_table_filter, aes(Percent_Difference, TSF, color = response_var)) +
  geom_jitter(position = position_jitter(0.2), alpha = 0.4) +
  geom_pointrange(aes(xmin = Percent_Difference - sd, xmax = Percent_Difference + sd, 
                      color = response_var),
                      position = position_dodge(width = -0.5), data = TSF.summary) +
  geom_vline(xintercept = 0, linewidth = 0.5, color = "red") +
  scale_y_discrete(limit = level_order) +
  xlim(-100, 700) +
  scale_color_manual(values = c("#00AFBB", "#E7B800"),
                     guide = guide_legend(title = "Analyte"),
                     labels = c('DOC', vn)) +
  theme_classic()

ggsave("site.difference.geom_pointrange.TSF.pdf",
       path = ("~/GitHub/rc_sfa-rc-3-wenas-modeling/Lit_Review_Fig"),
       width = 10, height = 8, units = "in")





```





```{r pairs test with MEB and JSC on 6/1/2023}
# With Pair with MEB and JSC on 6/1/2023 # 
Morgan_test <- metadata_long %>% 
  group_by(response_var, Study_ID, Pair_JSC) %>% 
  summarise(n = n(),
            mean = mean(mean_concentration),
            sd = sd(mean_concentration))


# plot # 
ggplot(summary, aes(x=Burn_Severity, y=mean, color=Feedstock))+
  geom_point()+
  geom_errorbar(aes(ymin=mean-sd, ymax=mean+sd))+
  theme_classic()+
  ylab("P Mobilized (%)")+ 
  xlab("Burn Severity")+
  scale_color_manual(values=c("#346648", "#dbb40d"))+
  facet_grid(variable~Feedstock, scales="free")+
  theme(text = element_text(size = 18), axis.text.x = element_text(angle=45, hjust = 1))+ theme(legend.position = "none")



```













```{r for loop attempt}
# Alan's code 
for(i in c("Douglas-fir forest", "Mixed Conifer forest", "Mountain woodland", "Sagebrush shrubland")) {
  print(c("#################### ANOVA ########################", i))
  print(anova(lmer(PercC6 ~ Burn_Severity) + (1|Parent_ID), data = subset(data_all, Land_Coverage_Category == i)))
  print("")
  print(c("#################### By Burn Severity ########################", i))
  print(summary(lmer(PercC6 ~ Burn_Severity + (1|Parent_ID), data = subset(data_all, Land_Coverage_Category == i))))
  print("")
}

# Stack exhange attempt 1
df <- data.frame(Yi0 =  1:10,
                 Yi1 = 21:30,
                 V1 = c(1,1,1,1,1,0,0,0,0,0),
                 V2 = c(0,1,0,1,0,1,0,1,0,1))

df %>%
  summarise(across(V1:V2, 
                ~ mean(df %>% 
                         filter(.x == 1) %>%
                         pull(Yi1), na.rm = T) -
                  mean(df %>% 
                         filter(.x == 0) %>%
                         pull(Yi0), na.rm = T)))

for(i in 1:10) {                                           
  x1 <- i^2                                                
  print(x1)                                                
}

x3 <- numeric()

for(i in 1:10) {                                           
  x3 <- c(x3, i^2)                                         
}
x3

for(i in 1:ncol(iris_new1)) {                              # Head of for-loop
  if(grepl("Width", colnames(iris_new1)[i])) {             # Logical condition
    iris_new1[ , i] <- iris_new1[ , i] + 1000              # Code block
  }
}



```


```{r Analyte summary stats}

# pivoting to make the responses in one column
metadata_long <- metadata %>% 
  pivot_longer(
    cols = DOC_mg_C_L:STER_NH4,
    names_to = "response_var",
    values_to = "mean_concentration",
    values_drop_na = TRUE
  )

# Generating the count of observations for each treatment by analyte
MeanConc <- metadata_long %>%
  group_by(Study_ID, Treatment, response_var, Climate) %>%
  dplyr::summarize(Ne = sum(Treatment == "Burn"),
                   Nc = sum(Treatment == "Unburn"),
                   Xe = mean(mean_concentration[Treatment == "Burn"], na.rm = TRUE),
                   Xc = mean(mean_concentration[Treatment == "Unburn"], na.rm = TRUE))


# Calculating effect size/percent_difference and other stats that we want to plot 
analyte_table <- MeanConc %>% 
  select(-Treatment) %>% 
  group_by(Study_ID, response_var, Climate) %>%
  summarize(Ne = sum(Ne),
            Nc = sum(Nc),
            Xe = sum(Xe, na.rm = TRUE),
            Xc = sum(Xc, na.rm = TRUE)) %>%
  mutate(lnR = log(Xe/Xc),
         percent_change = (((Xe-Xc)/Xc)*100),
         diff = Xe-Xc)

analyte_table$Xe <- format(analyte_table$Xe, scientific=F)
analyte_table$Xc <- format(analyte_table$Xc, scientific=F)


analyte_table <- analyte_table %>% 
  mutate(across(c(Climate),
                ~ifelse(Climate == "Temperate", "Temperate", "Mediterranean")))

write.csv(analyte_table, "~/GitHub/rc_sfa-rc-3-wenas-modeling/Lit_Review_Fig/analyte_table.csv", row.names=FALSE)


# Plot # This is all of the study IDs grouped together 
analyte_table_filter <- analyte_table %>% 
  filter(response_var == "DOC_mg_C_L"| response_var == "NO3_mg_per_L_as_Nitrate" | response_var == "NH4_mg_per_L_as_NH4"|
         response_var == "TDN_mg_N_per_L" | response_var == "TN_mg_N_per_L")

ggplot(analyte_table_filter, aes(x = percent_change, y = response_var, fill = response_var)) +
  geom_vline(xintercept = 0, linewidth = 1.0, color = "red") +
  geom_boxplot() +
  xlab("Percent Change") +
  ylab("") +
  xlim(-100, 500) +
  theme(axis.text.y = element_blank()) +
  scale_fill_brewer(palette="Set1",
                     guide = guide_legend(title = "Analyte"),
                     labels = c('DOC','NH4', 'NO3',
                                'TDN', 'TN')) +
  theme_classic()

ggsave("percent_change.pdf",
       path = ("~/GitHub/rc_sfa-rc-3-wenas-modeling/Lit_Review_Fig"),
       width = 10, height = 10, units = "in")
```





```{r}

############################## other attempts that may be useful ####################################
# Plots attempts # 
# pointplot with sd attempt #
ggplot(analyte_table_filter, aes(x = Percent_Difference, y = response_var, color = Site, shape = response_var)) +
  geom_vline(xintercept = 0, linewidth = 1.0, color = "red") +
  geom_point() +
  geom_errorbar(aes(xmin=Xe1-Sd1, xmax=Xe1+Sd1),
                linewidth = 0.2, color = "black", alpha = 0.9, size = 1.0)+
  xlab("Percent Difference") +
  ylab("") +
  theme(axis.text.y = element_blank()) +
  scale_color_brewer(palette="Set1") +
  facet_wrap(~Study_ID, scales = "free") +
  theme_classic()

ggsave("test.site.difference.pdf",
       path = ("~/GitHub/rc_sfa-rc-3-wenas-modeling/Lit_Review_Fig"),
       width = 25, height = 20, units = "in")

# geom_pointrange grouped by Climate #
ggplot(analyte_table_filter, aes(x = Percent_Difference, y = Climate, xmin = Xe1-Sd1, xmax = Xe1+Sd1)) +
  geom_point() +
  geom_errorbarh(height=.2) +
  xlim(-100, 500) 


df.summary <- analyte_table_filter %>%
  group_by(Climate) %>%
  summarise(
    sd = sd(Xc/Xe1, na.rm = TRUE),
    Percent_Difference = mean(Percent_Difference)
  )

df.summary

# calculating standard deviation  #
# with sd
# analyte_table_test2 <- MeanConcTest %>%
#   select(-Pair_JSC) %>%
#   group_by(Study_ID, response_var, Climate, TSF) %>%
#   summarize(Ne = sum(Ne),
#             Nc = sum(Nc),
#             Xe1 = sum(Xe[Pair_JSC == "Site 1"], na.rm = TRUE),
#             Sd1 = sum(Sde[Pair_JSC == "Site 1"], na.rm = TRUE),
#             Xe2 = sum(Xe[Pair_JSC == "Site 2"], na.rm = TRUE),
#             Sd2 = sum(Sde[Pair_JSC == "Site 2"], na.rm = TRUE),
#             Xe3 = sum(Xe[Pair_JSC == "Site 3"], na.rm = TRUE),
#             Sd3 = sum(Sde[Pair_JSC == "Site 3"], na.rm = TRUE),
#             Xe4 = sum(Xe[Pair_JSC == "Site 4"], na.rm = TRUE),
#             Sd4 = sum(Sde[Pair_JSC == "Site 4"], na.rm = TRUE),
#             Xe5 = sum(Xe[Pair_JSC == "Site 5"], na.rm = TRUE),
#             Sd5 = sum(Sde[Pair_JSC == "Site 5"], na.rm = TRUE),
#             Xe6 = sum(Xe[Pair_JSC == "Site 6"], na.rm = TRUE),
#             Sd6 = sum(Sde[Pair_JSC == "Site 6"], na.rm = TRUE),
#             Xe7 = sum(Xe[Pair_JSC == "Site 7"], na.rm = TRUE),
#             Sd7 = sum(Sde[Pair_JSC == "Site 7"], na.rm = TRUE),
#             Xe8 = sum(Xe[Pair_JSC == "Site 8"], na.rm = TRUE),
#             Sd8 = sum(Sde[Pair_JSC == "Site 8"], na.rm = TRUE),
#             Xe9 = sum(Xe[Pair_JSC == "Site 9"], na.rm = TRUE),
#             Sd9 = sum(Sde[Pair_JSC == "Site 9"], na.rm = TRUE),
#             Xe10 = sum(Xe[Pair_JSC == "Site 10"], na.rm = TRUE),
#             Sd10 = sum(Sde[Pair_JSC == "Site 10"], na.rm = TRUE),
#             Xc = sum(Xc[Pair_JSC == "Control"], na.rm = TRUE),
#             Sdc = sum(Sdc[Pair_JSC == "Control"], na.rm = TRUE))


# mutate(diff1 = Xe1 - Xc,
  #        diff2 = Xe2 - Xc,
  #        diff3 = Xe3 - Xc,
  #        diff4 = Xe4 - Xc,
  #        diff5 = Xe5 - Xc,
  #        diff6 = Xe6 - Xc,
  #        diff7 = Xe7 - Xc,
  #        diff8 = Xe8 - Xc,
  #        diff9 = Xe9 - Xc,
  #        diff10 = Xe10 - Xc) 

# By treatment and by response_var #
# By DOC
BurnDOC <- MeanConc %>% 
  filter(Treatment == "Burn" & response_var == "DOC_mg_C_L")

names(BurnDOC) <- c("Study_ID", "Treatment", "response", "Climate", "Ne", "Xe")

UnburnDOC <- MeanConc %>% 
  filter(Treatment == "Unburn" & response_var == "DOC_mg_C_L")

names(UnburnDOC) <- c("Study_ID", "Treatment", "response", "Climate", "Nc", "Xc")

DOC_table <- full_join(BurnDOC, UnburnDOC, by = c("Study_ID", "response"))

# By nitrate
BurnNO3 <- MeanConc %>% 
  filter(Treatment == "Burn" & response_var == "NO3_mg_per_L_as_Nitrate")

names(BurnNO3) <- c("Study_ID", "Treatment", "response", "Climate", "Ne", "Xe")

UnburnNO3 <- MeanConc %>% 
  filter(Treatment == "Unburn" & response_var == "NO3_mg_per_L_as_Nitrate")

names(UnburnNO3) <- c("Study_ID", "Treatment", "response", "Climate", "Nc", "Xc")

NO3_table <- full_join(BurnNO3, UnburnNO3, by = c("Study_ID", "response"))

# By TN
BurnTN <- MeanConc %>% 
  filter(Treatment == "Burn" & response_var == "TN_mg_N_per_L")

names(BurnTN) <- c("Study_ID", "Treatment", "response", "Climate", "Ne", "Xe")

UnburnTN <- MeanConc %>% 
  filter(Treatment == "Unburn" & response_var == "TN_mg_N_per_L")

names(UnburnTN) <- c("Study_ID", "Treatment", "response", "Climate", "Nc", "Xc")

TN_table <- full_join(BurnTN, UnburnTN, by = c("Study_ID", "response"))

# By NH4
BurnNH4 <- MeanConc %>% 
  filter(Treatment == "Burn" & response_var == "NH4_mg_per_L_as_NH4")

names(BurnNH4) <- c("Study_ID", "Treatment", "response", "Climate", "Ne", "Xe")

UnburnNH4 <- MeanConc %>% 
  filter(Treatment == "Unburn" & response_var == "NH4_mg_per_L_as_NH4")

names(UnburnNH4) <- c("Study_ID", "Treatment", "response", "Climate", "Nc", "Xc")

NH4_table <- full_join(BurnNH4, UnburnNH4, by = c("Study_ID", "response"))

# By TDN
BurnTDN <- MeanConc %>% 
  filter(Treatment == "Burn" & response_var == "TDN_mg_N_per_L")

names(BurnTDN) <- c("Study_ID", "Treatment", "response", "Climate", "Ne", "Xe")

UnburnTDN <- MeanConc %>% 
  filter(Treatment == "Unburn" & response_var == "TDN_mg_N_per_L")

names(UnburnTDN) <- c("Study_ID", "Treatment", "response", "Climate", "Nc", "Xc")

TDN_table <- full_join(BurnTDN, UnburnTDN, by = c("Study_ID", "response"))

# calculating ln([R])/changes in richness
# DOC
DOC_table <- DOC_table %>% 
  group_by(Study_ID) %>% 
  mutate(lnR = log(Xe/Xc),
         percent_change = 100*(1-lnR),
         diff = Xe-Xc)
# NO3 
NO3_table <- NO3_table %>% 
  group_by(Study_ID) %>% 
  mutate(lnR = log(Xe/Xc),
         percent_change = 100*(1-lnR),
         diff = Xe-Xc)

# TN
TN_table <- TN_table %>% 
  group_by(Study_ID) %>% 
  mutate(lnR = log(Xe/Xc),
         percent_change = 100*(1-lnR),
         diff = Xe-Xc)

# NH4
NH4_table <- NH4_table %>% 
  group_by(Study_ID) %>% 
  mutate(lnR = log(Xe/Xc),
         percent_change = 100*(1-lnR),
         diff = Xe-Xc)

# TDN
TDN_table <- TDN_table %>% 
  group_by(Study_ID) %>% 
  mutate(lnR = log(Xe/Xc),
         percent_change = 100*(1-lnR),
         diff = Xe-Xc)


MeanConcTest <- metadata_long %>% 
  group_by(Study_ID, Treatment, response_var, Climate) %>% 
  dplyr::summarize(Ne = sum(Treatment == "Burn"),
                   Nc = sum(Treatment == "Unburn"),
                   Xe = mean(mean_concentration[Treatment == "Burn"], na.rm = TRUE),
                   Xc = mean(mean_concentration[Treatment == "Unburn"], na.rm = TRUE))

MeanConcWide <- MeanConcTest %>% 
  pivot_wider(names_from = response_var, values_from = c(Xe, Xc))

# By treatment and by response_var #
# By DOC
BurnDOC <- MeanConcTest %>% 
  filter(Treatment == "Burn" & response_var == "DOC_mg_C_L")


# If else attempts # 
MeanConcTest <- MeanConc
unique(MeanConcTest$Treatment)
MeanConcTest$Ne <- ifelse(MeanConcTest$Treatment == 'Burn', print(MeanConcTest$N), ifelse(MeanConcTest$Treatment == 'Unburn', NA, 'Big'))

MeanConcTest$Nc <- ifelse(MeanConcTest$Treatment == 'Unburn', print(MeanConcTest$N), ifelse(MeanConcTest$Treatment == 'Burn', NA, 'Big'))
  


MeanConc <- metadata_long %>%
  group_by(Study_ID, Treatment, response_var, Climate) %>%
  dplyr::summarize(N = n(),
                   X = mean(mean_concentration, na.rm = TRUE))




MeanConcWide <- MeanConc %>% 
  pivot_wider(names_from = response_var, values_from = X)

MeanConcWideTest <- MeanConc %>% 
  pivot_wider(names_from = Treatment, values_from = N) %>% 
  pivot_wider(names_from = response_var, values_from = X)

MeanConcWideTest2 <- MeanConc %>% 
  pivot_wider(names_from = Treatment, values_from = N)

Table1 <- MeanConcWideTest2 %>% 
  group_by(Study_ID, response_var) %>% 
  dplyr::summarize(ratio = )
  

# By treatment #
Burn <- MeanConcWide %>% 
  filter(Treatment == "Burn")
                   
names(Burn) <- c("Study_ID", "Treatment", "Ne", "XeDOC", "XeNH4", "XeNO3", "SDdocE", "XeTN", "SEdocE",
                 "SDtnE", "SEno3E", "SDno3E", "SEnh4E") 
Unburn <- MeanConcWide %>% 
  filter(Treatment == "Unburn")
                   
names(Unburn) <- c("Study_ID", "Treatment", "Nc", "XcDOC", "XcNH4", "XcNO3", "SDdocC", "XcTN", "SEdocC", "SDtnC", "SEno3C", "SDno3C", "SEnh4C") # renaming the column headers to match that of the chem file 



Table1 <- full_join(Burn, Unburn, by = c("Study_ID"))

# select the columns that I want 
Table1 <- Table1[c("Study_ID", "Treatment", "Ne", "Nc", "XeDOC", "XeNH4", "XeNO3", "SDdocE",    "XeTN", "SEdocE", "SDtnE", "SEno3E", "SDno3E", "SEnh4E", "XcDOC", "XcNH4", "XcNO3", "SDdocC", "XcTN", "SEdocC", "SDtnC", "SEno3C", "SDno3C", "SEnh4C")]

table_long <- Table1 %>% 
  pivot_longer(
    cols = XeDOC:SEnh4C,
    names_to = "response_var",
    values_to = "mean_concentration",
    values_drop_na = TRUE
  )


Table2 <- Table1 %>% 
  group_by(Study_ID) %>% 
  mutate(percentDOC = ((1-(XeDOC/XcDOC))*100),
         percentNO3 = ((1-(XeNO3/XcNO3))*100),
         percentNH4 = ((1-(XeNH4/XcNH4))*100))

# Table3 <- table_long %>% 
#   group_by(Study_ID) %>% 
#   mutate(output = XeDOC/XcDOC)

```















